<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>LTW Lift Reliability Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: Arial, sans-serif;
    }

    #map {
      width: 100vw;
      height: 100vh;
    }

    .map-controls {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      background: rgba(255, 255, 255, 0.95);
      padding: 8px 10px;
      border-radius: 4px;
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
      font-size: 13px;
      line-height: 1.4;
    }

    .map-controls label {
      display: block;
      cursor: pointer;
      margin-bottom: 2px;
    }

    #station-search {
      width: 180px;
      margin-top: 6px;
      padding: 4px 6px;
      font-size: 13px;
      border: 1px solid #ccc;
      border-radius: 3px;
    }

    .map-legend {
      position: absolute;
      bottom: 10px;
      right: 10px;
      z-index: 1000;
      background: rgba(255, 255, 255, 0.95);
      padding: 8px 10px;
      border-radius: 4px;
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
      font-size: 12px;
      line-height: 1.4;
    }

    .legend-row {
      display: flex;
      align-items: center;
      margin-bottom: 2px;
    }

    .legend-swatch {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 6px;
      border: 1px solid #333;
    }

    .popup-title {
      font-weight: bold;
      font-size: 15px;
      margin-bottom: 4px;
    }

    .popup-meta {
      font-size: 13px;
      margin-bottom: 4px;
    }

    .popup-status-overall {
      font-size: 13px;
      margin-bottom: 6px;
    }

    .popup-modes {
      font-size: 13px;
      list-style: none;
      padding-left: 0;
      margin: 0;
    }

    .popup-modes li {
      margin-bottom: 2px;
    }

    .status-dot {
      display: inline-block;
      width: 9px;
      height: 9px;
      border-radius: 50%;
      margin-right: 4px;
      vertical-align: middle;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="map-controls">
    <label>
      <input type="checkbox" id="toggle-ltw" checked />
      LTW area stations
    </label>
    <label>
      <input type="checkbox" id="toggle-outside" />
      Outside LTW area
    </label>
    <label>
      <!-- default OFF so only stations WITH lifts show initially -->
      <input type="checkbox" id="toggle-no-lift" />
      Show stations with no lift
    </label>

    <input
      type="text"
      id="station-search"
      placeholder="Loading stations..."
      disabled
    />
  </div>

  <div class="map-legend">
    <div class="legend-row">
      <div class="legend-swatch" style="background:#00aa00;"></div>
      <span>All lifts working</span>
    </div>
    <div class="legend-row">
      <div class="legend-swatch" style="background:#ff3333;"></div>
      <span>All lifts out</span>
    </div>
    <div class="legend-row">
      <div class="legend-swatch" style="background:#ffb347;"></div>
      <span>Mixed / unknown</span>
    </div>
    <div class="legend-row">
      <div class="legend-swatch" style="background:#bbbbbb;"></div>
      <span>No lift at station</span>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    // ---- MAP SETUP --------------------------------------------------------
    const map = L.map("map").setView([51.5074, -0.1278], 11); // Central-ish London

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution:
        '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
    }).addTo(map);

    const toggleLTW = document.getElementById("toggle-ltw");
    const toggleOutside = document.getElementById("toggle-outside");
    const toggleNoLift = document.getElementById("toggle-no-lift");
    const stationSearchInput = document.getElementById("station-search");

    const allMarkers = [];

    // ---- HELPERS ----------------------------------------------------------

    function parseBoolean(v) {
      if (v == null) return false;
      const s = String(v).trim();
      if (!s) return false;
      return /^(true|t|1|y)$/i.test(s);
    }

    function parseCsv(text) {
      const lines = text.trim().split(/\r?\n/).filter(l => l.trim().length > 0);
      if (!lines.length) return [];

      const headerLine = lines[0];
      const headers = headerLine.split(",").map(h =>
        h.replace(/^"+|"+$/g, "").trim()
      );

      return lines.slice(1).map(line => {
        const cols = line.split(",");
        const obj = {};

        headers.forEach((h, i) => {
          let v = (cols[i] || "").trim();
          if (v.startsWith('"') && v.endsWith('"')) {
            v = v.slice(1, -1);
          }

          if (h === "station_id") {
            obj[h] = v ? parseInt(v, 10) : null;
          } else if (h === "latitude" || h === "longitude") {
            obj[h] = v ? parseFloat(v) : null;
          } else if (h === "in_ltw_area" || h === "has_lift") {
            obj[h] = parseBoolean(v);
          } else if (h === "lift_status") {
            obj[h] = v || null;
          } else {
            obj[h] = v;
          }
        });

        return obj;
      });
    }

    // Convert a status string to one of "working", "out", "unknown"
    function normaliseStatus(status) {
      const s = (status || "").toLowerCase().trim();
      if (s === "working") return "working";
      if (!s || s === "unknown") return "unknown";
      return "out";
    }

    // Build a "cluster key" to group nearby modes at the same station
    function makeGroupKey(rec) {
      const rawName = (rec.name || "").toString();
      const rawLower = rawName.toLowerCase();

      // Special handling: group all King's Cross variants together
      if (/king'?s\s+cross/.test(rawLower)) {
        return "cluster_kings_cross";
      }

      let norm = rawLower;

      // drop "london " prefix
      norm = norm.replace(/^london\s+/, "");

      // drop bracketed qualifiers
      norm = norm.replace(/\(.*?\)/g, " ");

      // drop generic words
      norm = norm.replace(/\b(overground|thameslink|underground|tube|station|rail|railway|intl|international)\b/g, " ");

      // collapse punctuation / spaces
      norm = norm.replace(/[^a-z0-9]+/g, " ").trim();

      if (!norm) norm = rawLower.trim() || "unknown";

      const lat = parseFloat(rec.latitude);
      const lon = parseFloat(rec.longitude);
      const latBucket = isFinite(lat) ? Math.round(lat * 10) / 10 : 0;
      const lonBucket = isFinite(lon) ? Math.round(lon * 10) / 10 : 0;

      return norm + "|" + latBucket + "|" + lonBucket;
    }

    function normaliseDisplayName(name) {
      if (!name) return "";
      if (/king'?s?\s+cross/i.test(name)) {
        return "London King's Cross";
      }
      return name;
    }

    function computeOverallStatus(modes) {
      const liftModes = modes.filter((m) => m.has_lift);

      if (liftModes.length === 0) return "no_lift";

      const statuses = liftModes.map((m) =>
        (m.lift_status || "").toLowerCase()
      );

      const allWorking = statuses.every((s) => s === "working");
      const allOut = statuses.every(
        (s) => s && s !== "working" && s !== "unknown"
      );
      const anyUnknown = statuses.some((s) => !s || s === "unknown");

      if (allWorking) return "all_working";
      if (allOut) return "all_out";
      if (anyUnknown) return "mixed_unknown";
      return "mixed";
    }

    function markerStyle(overallStatus, inLtwArea, hasLift) {
      let color;
      let fillColor;
      let radius = 7;

      if (!hasLift) {
        color = "#666666";
        fillColor = "#bbbbbb";
        radius = 6;
      } else if (overallStatus === "all_working") {
        color = "#006400";
        fillColor = "#00aa00";
      } else if (overallStatus === "all_out") {
        color = "#8b0000";
        fillColor = "#ff3333";
      } else {
        color = "#cc8400";
        fillColor = "#ffb347";
      }

      if (inLtwArea) radius += 1;

      return {
        radius: radius,
        color: color,
        weight: 2,
        fillColor: fillColor,
        fillOpacity: 0.9,
      };
    }

    function statusDotColor(lift_status, has_lift) {
      if (!has_lift) return "#888888";
      const s = (lift_status || "").toLowerCase();
      if (s === "working") return "#00aa00";
      if (!s || s === "unknown") return "#0077cc";
      return "#ff3333";
    }

    function overallStatusLabel(overallStatus, hasLift) {
      if (!hasLift) return "No lifts at this station";

      switch (overallStatus) {
        case "all_working":
          return "All lifts working";
        case "all_out":
          return "All lifts out of service";
        case "mixed":
          return "Some lifts working, some out of service";
        case "mixed_unknown":
          return "Some lifts working, some unknown/out of service";
        default:
          return "Lift status unknown";
      }
    }

    function updateMarkerVisibility() {
      allMarkers.forEach((rec) => {
        const showByArea =
          (rec.inLtwArea && toggleLTW.checked) ||
          (!rec.inLtwArea && toggleOutside.checked);

        // If "Show stations with no lift" is OFF, hide grey "no lift" stations
        const showByLift = toggleNoLift.checked ? true : rec.hasLift;

        const shouldShow = showByArea && showByLift;

        if (shouldShow) {
          if (!map.hasLayer(rec.marker)) rec.marker.addTo(map);
        } else {
          if (map.hasLayer(rec.marker)) map.removeLayer(rec.marker);
        }
      });
    }

    function setupSearch() {
      if (!stationSearchInput) return;

      stationSearchInput.disabled = false;
      stationSearchInput.placeholder = "Search station...";

      stationSearchInput.addEventListener("keydown", function (e) {
        if (e.key !== "Enter") return;

        const q = stationSearchInput.value.trim().toLowerCase();
        if (!q) return;

        let best = null;

        // Exact match first
        for (const rec of allMarkers) {
          if (rec.name && rec.name.toLowerCase() === q) {
            best = rec;
            break;
          }
        }

        // If no exact match, use first partial match
        if (!best) {
          for (const rec of allMarkers) {
            if (rec.name && rec.name.toLowerCase().includes(q)) {
              best = rec;
              break;
            }
          }
        }

        if (best) {
          const latlng = best.marker.getLatLng();
          map.setView(latlng, 16);
          best.marker.openPopup();
          stationSearchInput.style.borderColor = "#ccc";
        } else {
          // brief visual feedback if nothing found
          stationSearchInput.style.borderColor = "#cc0000";
          setTimeout(() => {
            stationSearchInput.style.borderColor = "#ccc";
          }, 700);
        }
      });
    }

    // ---- LOAD DATA & PLOT -------------------------------------------------

    Promise.all([
      fetch("ltw_station_map_data.json").then((r) => r.text()),
      fetch("correct_ltw_list.csv").then((r) => r.text()),
    ])
      .then(([jsonText, ltwCsvText]) => {
        let data;
        try {
          data = JSON.parse(jsonText);
        } catch (e) {
          data = parseCsv(jsonText);
        }

        const ltwRows = parseCsv(ltwCsvText);

        // station_id -> in_ltw_area (from correct LTW list)
        const ltwMap = new Map();
        ltwRows.forEach((row) => {
          const sid = row.station_id;
          if (sid != null && !Number.isNaN(sid)) {
            ltwMap.set(Number(sid), !!row.in_ltw_area);
          }
        });

        const stationGroups = {};

        data.forEach((rec) => {
          const sid = Number(rec.station_id);
          const inLtw = ltwMap.get(sid) === true; // default false

          const key = makeGroupKey(rec);

          if (!stationGroups[key]) {
            stationGroups[key] = {
              name: rec.name,
              latitude: rec.latitude,
              longitude: rec.longitude,
              in_ltw_area: inLtw,
              modesMap: {}, // mode -> aggregated info
            };
          } else if (inLtw) {
            stationGroups[key].in_ltw_area = true;
          }

          const group = stationGroups[key];

          const modeKey = (rec.mode || "Unknown").toString();
          if (!group.modesMap[modeKey]) {
            group.modesMap[modeKey] = {
              mode: modeKey,
              has_lift: false,
              lift_status: null,
            };
          }

          const modeRec = group.modesMap[modeKey];
          const hasLift = parseBoolean(rec.has_lift);

          if (hasLift) {
            modeRec.has_lift = true;

            const newStatus = normaliseStatus(rec.lift_status);
            const current = modeRec.lift_status;

            if (!current) {
              modeRec.lift_status = newStatus;
            } else if (current === "working") {
              if (newStatus === "out") modeRec.lift_status = "out";
            } else if (current === "unknown") {
              if (newStatus === "working" || newStatus === "out") {
                modeRec.lift_status = newStatus;
              }
            }
            // if current is "out", keep it
          }
        });

        Object.values(stationGroups).forEach((station) => {
          station.name = normaliseDisplayName(station.name);

          const modes = Object.values(station.modesMap);
          station.modes = modes;

          const hasLift = modes.some((m) => m.has_lift);
          const overall = computeOverallStatus(modes);
          const style = markerStyle(overall, station.in_ltw_area, hasLift);

          const marker = L.circleMarker(
            [station.latitude, station.longitude],
            style
          );

          const overallText = overallStatusLabel(overall, hasLift);
          const ltwText = station.in_ltw_area ? "Yes" : "No";

          let popupHtml = "";
          popupHtml += `<div class="popup-title">${station.name}</div>`;
          popupHtml += `<div class="popup-meta">LTW area: <strong>${ltwText}</strong></div>`;
          popupHtml += `<div class="popup-status-overall">Overall status: <strong>${overallText}</strong></div>`;
          popupHtml += `<div class="popup-meta"><strong>Modes &amp; lift status</strong></div>`;
          popupHtml += `<ul class="popup-modes">`;

          modes.forEach((m) => {
            const dotColor = statusDotColor(m.lift_status, m.has_lift);
            const statusLabel = m.has_lift
              ? (m.lift_status ? m.lift_status : "unknown")
              : "no lift";

            popupHtml += `<li><span class="status-dot" style="background:${dotColor};"></span>${m.mode}: ${statusLabel}</li>`;
          });

          popupHtml += `</ul>`;

          marker.bindPopup(popupHtml);
          marker.addTo(map);

          allMarkers.push({
            marker: marker,
            inLtwArea: station.in_ltw_area,
            hasLift: hasLift,
            name: station.name,
          });
        });

        updateMarkerVisibility();
        setupSearch();
      })
      .catch((err) => {
        console.error("Error loading map data or LTW list:", err);
        alert(
          "There was a problem loading ltw_station_map_data.json and/or correct_ltw_list.csv. " +
          "Please check both files are in the same folder as this HTML file."
        );
      });

    // ---- CONTROLS ---------------------------------------------------------

    toggleLTW.addEventListener("change", updateMarkerVisibility);
    toggleOutside.addEventListener("change", updateMarkerVisibility);
    toggleNoLift.addEventListener("change", updateMarkerVisibility);
  </script>
</body>
</html>